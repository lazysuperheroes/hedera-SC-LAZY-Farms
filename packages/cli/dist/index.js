#!/usr/bin/env node
"use strict";var bt=Object.create;var z=Object.defineProperty;var Ct=Object.getOwnPropertyDescriptor;var Ot=Object.getOwnPropertyNames;var Rt=Object.getPrototypeOf,vt=Object.prototype.hasOwnProperty;var It=(t,n,e,o)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of Ot(n))!vt.call(t,r)&&r!==e&&z(t,r,{get:()=>n[r],enumerable:!(o=Ct(n,r))||o.enumerable});return t};var P=(t,n,e)=>(e=t!=null?bt(Rt(t)):{},It(n||!t||!t.__esModule?z(e,"default",{value:t,enumerable:!0}):e,t));var yt=require("commander");var rt=require("commander");var q={mainnet:"https://mainnet-public.mirrornode.hedera.com",testnet:"https://testnet.mirrornode.hedera.com"},G={LAZY_TOKEN:"0.0.1311037",LAZY_SCT:"0.0.1311003",GAS_STATION:"0.0.7221483",DELEGATE_REGISTRY:"0.0.7221486",NFT_STAKING:"0.0.7221488",MISSION_FACTORY:"0.0.8257122",MISSION_TEMPLATE:"0.0.8257118",BOOST_MANAGER:"0.0.8257105",PRNG:"0.0.8257116"},U={LAZY_TOKEN:"",LAZY_SCT:"",GAS_STATION:"",DELEGATE_REGISTRY:"",NFT_STAKING:"",MISSION_FACTORY:"",MISSION_TEMPLATE:"",BOOST_MANAGER:"",PRNG:""};function T(t){return t==="mainnet"?G:U}var H={LAZY:1,HBAR:8},j=["C","R","SR","UR","LR","SPE"];function Y(t){return j[t]??String(t)}var F=P(require("axios"));function V(t){return q[t]}async function D(t,n){let e=`${V(t)}${n}`;try{return(await F.default.get(e,{timeout:1e4})).data}catch(o){if(o instanceof F.AxiosError){if(o.response?.status===404)return null;throw new Error(`Mirror node error: ${o.message}`)}throw o}}async function E(t,n){return D(t,`/api/v1/tokens/${n}`)}async function Q(t,n){let e=[],o=`/api/v1/accounts/${n}/allowances/tokens?limit=100`;for(;o;){let r=await D(t,o);if(!r)break;e.push(...r.allowances),o=r.links.next?r.links.next:null}return e}async function X(t,n){let e=[],o=`/api/v1/accounts/${n}/allowances/nfts?limit=100`;for(;o;){let r=await D(t,o);if(!r)break;e.push(...r.allowances),o=r.links.next?r.links.next:null}return e}async function tt(t,n){let e=[],o=`/api/v1/accounts/${n}/allowances/crypto?limit=100`;for(;o;){let r=await D(t,o);if(!r)break;e.push(...r.allowances),o=r.links.next?r.links.next:null}return e}async function nt(t,n){return D(t,`/api/v1/contracts/${n}`)}function _t(t){if(t.startsWith("0x"))return t;let n=t.split(".");if(n.length!==3)throw new Error(`Invalid Hedera ID format: ${t}`);let e=parseInt(n[2],10);if(isNaN(e))throw new Error(`Invalid entity number in Hedera ID: ${t}`);return"0x"+e.toString(16).padStart(40,"0")}async function m(t,n,e){let o=`${V(t)}/api/v1/contracts/call`,r=_t(n);try{return(await F.default.post(o,{block:"latest",data:e,estimate:!1,to:r},{timeout:15e3})).data.result}catch(s){throw s instanceof F.AxiosError?new Error(`Contract call failed: ${s.response?.data?.message||s.message}`):s}}function et(t,n){let e=Math.pow(10,n);return(Number(t)/e).toLocaleString(void 0,{maximumFractionDigits:n})}function v(t){return et(t,H.LAZY)}function ot(t){return et(t,H.HBAR)}var I=require("ethers"),ht=["function getStakingUsers() view returns (address[])","function getStakableCollections() view returns (address[])","function getStakedNFTs(address _user) view returns (address[] collections, uint256[][] serials)","function getStakedSerials(address _collection) view returns (uint256[])","function getNumStakedNFTs(address _collection) view returns (uint256)","function getBaseRewardRate(address _user) view returns (uint256)","function getActiveBoostRate(address _user) view returns (uint256)","function getMaxBaseRate(address _user) view returns (uint256)"],k=new I.Interface(ht),xt=["function getDeployedMissions() view returns (address[])","function getAvailableSlots() view returns (address[], uint256[], uint256[])","function getLiveMissions(address _user) view returns (address[], uint256[], bool[])","function isAdmin(address _wallet) view returns (bool)","function lazyToken() view returns (address)","function lazyGasStation() view returns (address)","function boostManager() view returns (address)","function prngGenerator() view returns (address)","function lazyDelegateRegistry() view returns (address)"],M=new I.Interface(xt),Ft=["function getSlotsRemaining() view returns (uint256)","function getUsersOnMission() view returns (address[])","function isParticipant(address _user) view returns (bool)","function entryFee() view returns (uint256)","function getMissionParticipation(address _user) view returns (uint256 _entryTimestamp, uint256 _endOfMissionTimestamp, bool _boosted)","function getUserEndAndBoost(address _user) view returns (uint256 _endOfMissionTimestamp, bool boosted)","function getRequirements() view returns (address[] _requiredCollections, uint256[] _requiredQuantities, address _rewardCollection, uint256 _rewardsPerUser, uint256 _missionDuration, uint256 _maxParticipants, uint256 _minTier)","function getDecrementDetails() view returns (bool, uint256, uint256, uint256)"],C=new I.Interface(Ft),Et=["function getGemCollections() view returns (address[])","function getBoostLevel(address _collectionAddress, uint256 _tokenId) view returns (uint8)","function getBoostData(uint8 _boostLevel) view returns (address[], bool[], uint256[][], uint256)","function hasBoost(address _missionParticipant, address _mission) view returns (bool)","function getBoostItem(address _mission, address _user) view returns (uint8, address, uint256)"],J=new I.Interface(Et),Mt=["function getDelegateWallet(address _wallet) view returns (address)","function checkDelegateWallet(address _actualWallet, address _proposedDelegate) view returns (bool)","function getWalletsDelegatedTo(address _delegate) view returns (address[])"],on=new I.Interface(Mt),Bt=["function isContractUser(address _contractAddress) view returns (bool)"],rn=new I.Interface(Bt);function f(t,n,e=[]){return t.encodeFunctionData(n,e)}function g(t,n,e){return t.decodeFunctionResult(n,e)}var K=P(require("cli-table3")),_=P(require("chalk"));function B(t,n,e){if(e.json){console.log(JSON.stringify(t,null,2));return}Array.isArray(t)?N(t,n):Lt(t)}function N(t,n){if(t.length===0){console.log(_.default.yellow("No data found."));return}let e=new K.default({head:n.map(o=>_.default.cyan(o)),style:{head:[],border:[]}});for(let o of t)e.push(n.map(r=>String(o[r]??"")));console.log(e.toString())}function Lt(t){let n=new K.default({style:{head:[],border:[]}});for(let[e,o]of Object.entries(t))n.push([_.default.cyan(e),String(o??"")]);console.log(n.toString())}function a(t){console.error(_.default.red("\u2717 ")+t)}function S(t){console.log(_.default.yellow("! ")+t)}function A(t){console.log(),console.log(_.default.bold.underline(t)),console.log()}function st(){return new rt.Command("info").description("Display system information and contract details").option("--testnet","Use testnet instead of mainnet").option("--json","Output as JSON").action(async n=>{let e=n.testnet?"testnet":"mainnet";await Dt({network:e,json:n.json})})}async function Dt(t){let n=T(t.network);if(!n.LAZY_TOKEN){a(`No contracts deployed on ${t.network}`);return}try{let e=await E(t.network,n.LAZY_TOKEN),o=await $t(t.network,n.NFT_STAKING),r=await jt(t.network,n.MISSION_FACTORY),s={Network:t.network,"LAZY Token":n.LAZY_TOKEN,"LAZY Symbol":e?.symbol??"N/A","LAZY Total Supply":e?v(parseInt(e.total_supply)):"N/A","NFT Staking Contract":n.NFT_STAKING,"Stakable Collections":o.collectionCount?.toString()??"N/A","Active Stakers":o.stakerCount?.toString()??"N/A","Mission Factory":n.MISSION_FACTORY,"Active Missions":r?.toString()??"N/A","Boost Manager":n.BOOST_MANAGER,"Delegate Registry":n.DELEGATE_REGISTRY,"Gas Station":n.GAS_STATION};t.json||A(`Lazy Farming System - ${t.network}`),B(s,[],t)}catch(e){a(`Failed to fetch info: ${e instanceof Error?e.message:String(e)}`)}}async function $t(t,n){let e={collectionCount:null,stakerCount:null};try{let o=f(k,"getStakableCollections"),r=await m(t,n,o);if(r){let p=g(k,"getStakableCollections",r)[0];e.collectionCount=p.length}let s=f(k,"getStakingUsers"),i=await m(t,n,s);if(i){let p=g(k,"getStakingUsers",i)[0];e.stakerCount=p.length}}catch{}return e}async function jt(t,n){try{let e=f(M,"getDeployedMissions"),o=await m(t,n,e);if(o)return g(M,"getDeployedMissions",o)[0].length}catch{}return null}var it=require("commander");function at(){return new it.Command("rewards").description("Query staking info and reward rates for an account").argument("<account>","Account ID (e.g., 0.0.12345)").option("--testnet","Use testnet instead of mainnet").option("--json","Output as JSON").action(async(n,e)=>{let o=e.testnet?"testnet":"mainnet";await Pt(n,{network:o,json:e.json})})}async function Pt(t,n){let e=T(n.network);if(!e.NFT_STAKING){a(`No contracts deployed on ${n.network}`);return}try{let o=Gt(t);if(!o){a(`Could not convert account ${t} to EVM address`);return}let r=f(k,"getStakedNFTs",[o]),s=await m(n.network,e.NFT_STAKING,r);if(!s){S("No staking info found for this account");return}let i=g(k,"getStakedNFTs",s),u=i[0],l=i[1].reduce(($,L)=>$+L.length,0);if(l===0){S("No staked NFTs found for this account"),n.json&&console.log(JSON.stringify({account:t,totalStaked:0,collections:0},null,2));return}let c=f(k,"getBaseRewardRate",[o]),d=await m(n.network,e.NFT_STAKING,c),w=d?BigInt(String(g(k,"getBaseRewardRate",d))):null,y=f(k,"getActiveBoostRate",[o]),R=await m(n.network,e.NFT_STAKING,y),b=R?BigInt(String(g(k,"getActiveBoostRate",R))):null,h=[];for(let $ of u){let L=Ut($);if(L){let Tt=await E(n.network,L);h.push(Tt?.symbol||L)}else h.push($)}let x={Account:t,"EVM Address":o,"Total Staked NFTs":l.toString(),"Collections Staked":u.length.toString(),"Collection Names":h.join(", "),"Base Reward Rate":w!==null?w.toString():"N/A","Active Boost Rate":b!==null?b.toString():"N/A",Note:"Pending rewards require backend signature verification"};if(n.json){console.log(JSON.stringify({account:t,evmAddress:o,totalStaked:l,collections:u.length,collectionNames:h,baseRate:w?.toString()??null,boostRate:b?.toString()??null},null,2));return}A(`Staking Info - ${n.network}`),B(x,[],n)}catch(o){a(`Failed to fetch staking info: ${o instanceof Error?o.message:String(o)}`)}}function Gt(t){if(t.startsWith("0x"))return t;let n=t.split(".");return n.length===3?"0x"+parseInt(n[2]).toString(16).padStart(40,"0"):null}function Ut(t){try{let n=t.replace("0x","");return`0.0.${parseInt(n,16)}`}catch{return null}}var ct=require("commander");function ut(){return new ct.Command("staked").description("Query staked NFTs for an account").argument("<account>","Account ID (e.g., 0.0.12345)").option("--testnet","Use testnet instead of mainnet").option("--json","Output as JSON").action(async(n,e)=>{let o=e.testnet?"testnet":"mainnet";await Ht(n,{network:o,json:e.json})})}async function Ht(t,n){let e=T(n.network);if(!e.NFT_STAKING){a(`No contracts deployed on ${n.network}`);return}try{let o=Yt(t);if(!o){a(`Could not convert account ${t} to EVM address`);return}let r=f(k,"getStakedNFTs",[o]),s=await m(n.network,e.NFT_STAKING,r);if(!s){S("No staked NFTs found for this account");return}let i=g(k,"getStakedNFTs",s),u=i[0],p=i[1];if(u.length===0){S("No staked NFTs found for this account"),n.json&&console.log(JSON.stringify({account:t,stakedNFTs:[]},null,2));return}let l=[];for(let c=0;c<u.length;c++){let d=u[c],w=p[c].map(b=>Number(b)),y=lt(d),R=y;if(y){let b=await E(n.network,y);b&&(R=b.symbol||y)}l.push({Collection:R||d,Token:y||d,Serials:w.slice(0,10).join(", ")+(w.length>10?"...":""),Count:w.length})}if(n.json){let c={account:t,network:n.network,stakedNFTs:u.map((d,w)=>({token:lt(d)||d,serials:p[w].map(y=>Number(y)),count:p[w].length})),totalStaked:p.reduce((d,w)=>d+w.length,0)};console.log(JSON.stringify(c,null,2))}else A(`Staked NFTs - ${t}`),N(l,["Collection","Token","Serials","Count"]),console.log(`
Total staked: ${p.reduce((c,d)=>c+d.length,0)} NFTs across ${u.length} collection(s)`)}catch(o){a(`Failed to fetch staked NFTs: ${o instanceof Error?o.message:String(o)}`)}}function Yt(t){if(t.startsWith("0x"))return t;let n=t.split(".");return n.length===3?"0x"+parseInt(n[2]).toString(16).padStart(40,"0"):null}function lt(t){try{let n=t.replace("0x","");return`0.0.${parseInt(n,16)}`}catch{return null}}var dt=require("commander");function mt(){return new dt.Command("allowances").description("Query token and NFT allowances for an account").argument("<account>","Account ID (e.g., 0.0.12345)").option("--testnet","Use testnet instead of mainnet").option("--type <type>","Filter by type: all, ft, nft, hbar (default: all)","all").option("--json","Output as JSON").action(async(n,e)=>{let o=e.testnet?"testnet":"mainnet";await Jt(n,{network:o,type:e.type,json:e.json})})}async function Jt(t,n){let e=T(n.network),o=n.type??"all";try{let r={};if(o==="all"||o==="ft"){let s=await Q(n.network,t);r.ftAllowances=s.map(i=>({Token:i.token_id,Spender:i.spender,Amount:v(i.amount),"Is Contract":Z(i.spender,e)||""}))}if(o==="all"||o==="nft"){let s=await X(n.network,t);r.nftAllowances=s.map(i=>({Token:i.token_id,Spender:i.spender,"Approved For All":i.approved_for_all?"Yes":"No","Is Contract":Z(i.spender,e)||""}))}if(o==="all"||o==="hbar"){let s=await tt(n.network,t);r.hbarAllowances=s.map(i=>({Spender:i.spender,Amount:ot(i.amount)+" HBAR","Is Contract":Z(i.spender,e)||""}))}if(n.json){console.log(JSON.stringify({account:t,network:n.network,...r},null,2));return}A(`Allowances - ${t}`),r.ftAllowances!==void 0&&(console.log(`
Fungible Token Allowances:`),r.ftAllowances.length===0?S("No FT allowances found"):N(r.ftAllowances,["Token","Spender","Amount","Is Contract"])),r.nftAllowances!==void 0&&(console.log(`
NFT Allowances:`),r.nftAllowances.length===0?S("No NFT allowances found"):N(r.nftAllowances,["Token","Spender","Approved For All","Is Contract"])),r.hbarAllowances!==void 0&&(console.log(`
HBAR Allowances:`),r.hbarAllowances.length===0?S("No HBAR allowances found"):N(r.hbarAllowances,["Spender","Amount","Is Contract"]))}catch(r){a(`Failed to fetch allowances: ${r instanceof Error?r.message:String(r)}`)}}function Z(t,n){for(let[e,o]of Object.entries(n))if(o===t)return e.replace(/_/g," ");return""}var ft=require("commander");function gt(){let t=new ft.Command("missions").description("List and query missions").option("--testnet","Use testnet instead of mainnet").option("--json","Output as JSON").action(async n=>{let e=n.testnet?"testnet":"mainnet";await Kt({network:e,json:n.json})});return t.command("details <mission>").description("Get details for a specific mission").option("--testnet","Use testnet instead of mainnet").option("--json","Output as JSON").action(async(n,e)=>{let o=e.testnet?"testnet":"mainnet";await Zt(n,{network:o,json:e.json})}),t}async function Kt(t){let n=T(t.network);if(!n.MISSION_FACTORY){a(`No contracts deployed on ${t.network}`);return}try{let e=f(M,"getAvailableSlots"),o=await m(t.network,n.MISSION_FACTORY,e);if(!o){S("Could not fetch missions");return}let r=g(M,"getAvailableSlots",o),s=r[0],i=r[1],u=r[2];if(s.length===0){S("No missions deployed"),t.json&&console.log(JSON.stringify({network:t.network,missions:[],count:0},null,2));return}let p=[];for(let l=0;l<s.length;l++){let c=s[l],d=pt(c);p.push({Index:l,Address:d||c,"Slots Available":i[l].toString(),"Entry Fee":v(i[l])+" $LAZY"})}if(t.json){console.log(JSON.stringify({network:t.network,totalCount:s.length,missions:p.map((l,c)=>({index:l.Index,address:l.Address,slotsAvailable:Number(i[c]),entryFee:Number(u[c])}))},null,2));return}A(`Missions - ${t.network}`),console.log(`Total missions: ${s.length}
`),N(p,["Index","Address","Slots Available","Entry Fee"])}catch(e){a(`Failed to fetch missions: ${e instanceof Error?e.message:String(e)}`)}}async function Zt(t,n){try{let e=await Wt(n.network,t);if(!e){a(`Could not fetch mission info for ${t}`);return}let o={"Mission ID":t,"Entry Fee":v(e.entryFee)+" $LAZY","Slots Remaining":e.slotsRemaining.toString(),Duration:`${e.duration} seconds (${(e.duration/3600).toFixed(1)} hours)`,"Max Participants":e.maxParticipants.toString(),"Rewards Per User":e.rewardsPerUser.toString(),"Reward Collection":e.rewardCollection?pt(e.rewardCollection)||e.rewardCollection:"N/A","Active Users":e.usersOnMission.toString()};n.json||A("Mission Details"),B(o,[],n)}catch(e){a(`Failed to fetch mission details: ${e instanceof Error?e.message:String(e)}`)}}async function Wt(t,n){try{let e=f(C,"entryFee"),o=await m(t,n,e),r=o?BigInt(String(g(C,"entryFee",o))):0n,s=f(C,"getSlotsRemaining"),i=await m(t,n,s),u=i?BigInt(String(g(C,"getSlotsRemaining",i))):0n,p=f(C,"getRequirements"),l=await m(t,n,p),c=0,d=0,w=0,y="";if(l){let x=g(C,"getRequirements",l);y=x[2],w=Number(x[3]),c=Number(x[4]),d=Number(x[5])}let R=f(C,"getUsersOnMission"),b=await m(t,n,R),h=b?g(C,"getUsersOnMission",b).length:0;return{entryFee:r,slotsRemaining:u,duration:c,maxParticipants:d,rewardsPerUser:w,rewardCollection:y,usersOnMission:h}}catch{return null}}function pt(t){try{let n=t.replace("0x","");return`0.0.${parseInt(n,16)}`}catch{return null}}var kt=require("commander");function At(){return new kt.Command("boost-levels").description("Display gem boost level information").option("--testnet","Use testnet instead of mainnet").option("--json","Output as JSON").action(async n=>{let e=n.testnet?"testnet":"mainnet";await zt({network:e,json:n.json})})}async function zt(t){let n=T(t.network);if(!n.BOOST_MANAGER){a(`No contracts deployed on ${t.network}`);return}try{let e=[];for(let o=0;o<j.length;o++){let r=await wt(t.network,n.BOOST_MANAGER,o);r&&e.push({Level:o.toString(),Name:Y(o),"Boost Reduction %":r.boostReduction.toString()+"%",Collections:r.collections.length.toString()})}if(e.length===0){a("Could not fetch boost level data");return}if(t.json){let o=await Promise.all(Array.from({length:j.length},(r,s)=>wt(t.network,n.BOOST_MANAGER,s).then(i=>({level:s,name:Y(s),boostReduction:i?.boostReduction??0,collections:i?.collections.map(u=>qt(u)||u)??[]}))));console.log(JSON.stringify({network:t.network,boostManager:n.BOOST_MANAGER,levels:o},null,2));return}A(`Boost Levels - ${t.network}`),console.log(`Boost Manager: ${n.BOOST_MANAGER}
`),N(e,["Level","Name","Boost Reduction %","Collections"])}catch(e){a(`Failed to fetch boost levels: ${e instanceof Error?e.message:String(e)}`)}}async function wt(t,n,e){try{let o=f(J,"getBoostData",[e]),r=await m(t,n,o);if(!r)return null;let s=g(J,"getBoostData",r);return{collections:s[0],serialLocked:s[1],serials:s[2],boostReduction:Number(s[3])}}catch{return null}}function qt(t){try{let n=t.replace("0x","");return`0.0.${parseInt(n,16)}`}catch{return null}}var Nt=require("commander");function St(){return new Nt.Command("deployments").description("Show deployment manifest information").option("--testnet","Use testnet instead of mainnet").option("--verify","Verify contracts exist on network").option("--json","Output as JSON").action(async n=>{let e=n.testnet?"testnet":"mainnet";await Vt({network:e,verify:n.verify,json:n.json})})}async function Vt(t){let n=t.network==="mainnet"?G:U,e=[];for(let[o,r]of Object.entries(n)){let s=r?"Configured":"Not deployed";t.verify&&r&&(s=await Qt(t.network,r)?"Verified":"Not found"),e.push({Contract:W(o),Address:r||"N/A",Status:s})}if(t.json){console.log(JSON.stringify({network:t.network,verified:t.verify??!1,contracts:Object.fromEntries(Object.entries(n).map(([o,r])=>[W(o),{address:r||null,status:e.find(s=>s.Contract===W(o))?.Status??"Unknown"}]))},null,2));return}A(`Deployments - ${t.network}`),t.verify&&console.log(`(Contracts verified against network)
`),N(e,["Contract","Address","Status"])}async function Qt(t,n){try{return await nt(t,n)!==null}catch{return!1}}function W(t){return t.split("_").map(n=>n.charAt(0)+n.slice(1).toLowerCase()).join(" ")}var O=new yt.Command;O.name("lazy-farm").description("Read-only CLI for querying Lazy Superheroes farming and staking contracts on Hedera").version("1.0.0");O.addCommand(st());O.addCommand(at());O.addCommand(ut());O.addCommand(mt());O.addCommand(gt());O.addCommand(At());O.addCommand(St());O.parse();
